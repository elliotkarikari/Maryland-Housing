-- Migration 012: Layer 6 Risk Vulnerability Overhaul
-- Adds modern climate projections, vulnerability assessment, and adaptive capacity metrics
-- Date: 2026-01-29

-- =============================================================================
-- TRACT-LEVEL TABLE: Primary analysis unit for risk vulnerability
-- =============================================================================
CREATE TABLE IF NOT EXISTS layer6_risk_vulnerability_tract (
    id SERIAL PRIMARY KEY,

    -- Geography identifiers
    tract_geoid VARCHAR(11) NOT NULL,           -- 11-digit census tract FIPS
    fips_code VARCHAR(5) NOT NULL,              -- County FIPS for rollup
    data_year INTEGER NOT NULL,

    -- Population for weighting
    total_population INTEGER,
    vulnerable_population INTEGER,               -- Under 5 + over 65 + disability
    low_income_population INTEGER,              -- Below 200% poverty

    -- v1 Static Flood Risk (retained from county level)
    sfha_pct_of_tract NUMERIC(5,4),             -- Special Flood Hazard Area percentage
    in_100yr_floodplain BOOLEAN,
    in_500yr_floodplain BOOLEAN,

    -- v2 Climate Projections (NEW)
    -- Sea Level Rise
    slr_exposure_1ft NUMERIC(5,4),              -- Fraction of tract exposed at 1ft SLR
    slr_exposure_2ft NUMERIC(5,4),              -- Fraction exposed at 2ft SLR (2050 median)
    slr_exposure_3ft NUMERIC(5,4),              -- Fraction exposed at 3ft SLR (2050 high)
    slr_risk_score NUMERIC(5,4),                -- Normalized SLR vulnerability (0-1)

    -- Extreme Heat (from NOAA/CDC projections)
    heat_days_above_95f_current INTEGER,        -- Current baseline
    heat_days_above_95f_2050 INTEGER,           -- 2050 projection (RCP 4.5)
    heat_days_above_100f_2050 INTEGER,          -- 2050 extreme heat days
    heat_wave_duration_2050 INTEGER,            -- Avg consecutive hot days
    heat_vulnerability_score NUMERIC(5,4),      -- Normalized heat risk (0-1)

    -- Urban Heat Island
    urban_heat_island_intensity NUMERIC(6,2),   -- Degrees above rural baseline
    impervious_surface_pct NUMERIC(5,4),        -- Hard surface coverage
    tree_canopy_pct NUMERIC(5,4),               -- Tree cover (cooling effect)

    -- v2 Pollution Vulnerability (expanded EJScreen)
    pm25_concentration NUMERIC(6,2),            -- Annual PM2.5 (ug/m3)
    ozone_concentration NUMERIC(6,2),           -- Annual ozone (ppb)
    diesel_pm_exposure NUMERIC(8,2),            -- Diesel particulate
    air_toxics_cancer_risk NUMERIC(10,6),       -- Cancer risk from air toxics
    lead_paint_indicator NUMERIC(5,4),          -- Pre-1960 housing proxy
    proximity_superfund NUMERIC(8,2),           -- Distance to NPL sites
    proximity_rmp_facilities NUMERIC(8,2),      -- Distance to RMP facilities
    proximity_hazwaste NUMERIC(8,2),            -- Distance to TSDFs
    proximity_wastewater NUMERIC(8,2),          -- Distance to wastewater discharge
    pollution_burden_score NUMERIC(5,4),        -- Composite pollution (0-1)

    -- v2 Social Vulnerability (CDC SVI components)
    pct_below_poverty NUMERIC(5,4),
    pct_unemployed NUMERIC(5,4),
    pct_no_high_school NUMERIC(5,4),
    pct_uninsured NUMERIC(5,4),
    pct_age_65_plus NUMERIC(5,4),
    pct_age_under_5 NUMERIC(5,4),
    pct_disability NUMERIC(5,4),
    pct_limited_english NUMERIC(5,4),
    pct_minority NUMERIC(5,4),
    pct_mobile_homes NUMERIC(5,4),
    pct_multi_unit_housing NUMERIC(5,4),
    pct_no_vehicle NUMERIC(5,4),
    pct_group_quarters NUMERIC(5,4),
    socioeconomic_vulnerability NUMERIC(5,4),   -- SVI Theme 1
    household_vulnerability NUMERIC(5,4),       -- SVI Theme 2
    minority_language_vulnerability NUMERIC(5,4), -- SVI Theme 3
    housing_transport_vulnerability NUMERIC(5,4), -- SVI Theme 4
    social_vulnerability_index NUMERIC(5,4),    -- CDC SVI composite (0-1)

    -- v2 Infrastructure Resilience
    road_flood_exposure_pct NUMERIC(5,4),       -- Roads in flood zone
    critical_facility_flood_risk INTEGER,       -- Hospitals/fire/police in flood zone
    power_outage_risk_score NUMERIC(5,4),       -- Grid vulnerability
    broadband_access_pct NUMERIC(5,4),          -- Internet for emergency info
    evacuation_route_access BOOLEAN,            -- Access to major evacuation route

    -- v2 Adaptive Capacity (positive factors)
    hospital_access_score NUMERIC(5,4),         -- Healthcare accessibility
    emergency_service_access_score NUMERIC(5,4), -- Fire/EMS accessibility
    cooling_center_access BOOLEAN,              -- Nearby cooling center
    green_space_access_pct NUMERIC(5,4),        -- Parks/open space
    community_resilience_score NUMERIC(5,4),    -- Based on civic engagement proxies
    adaptive_capacity_index NUMERIC(5,4),       -- Composite adaptive capacity (0-1)

    -- Normalized Scores (0-1 scale, higher = more risk)
    static_risk_score NUMERIC(5,4),             -- v1: flood + pollution + infrastructure
    climate_projection_score NUMERIC(5,4),      -- v2: SLR + heat projections
    vulnerability_score NUMERIC(5,4),           -- v2: social + environmental vulnerability
    resilience_deficit_score NUMERIC(5,4),      -- 1 - adaptive_capacity (higher = less resilient)
    risk_vulnerability_composite NUMERIC(5,4), -- Weighted composite

    -- Data provenance
    ejscreen_year INTEGER,
    svi_year INTEGER,
    climate_projection_source VARCHAR(50),      -- e.g., 'NOAA_SLR_2022', 'CDC_HEAT_2023'
    computation_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- Constraints
    CONSTRAINT uq_tract_risk_year UNIQUE (tract_geoid, data_year)
);

-- Indexes for tract table
CREATE INDEX IF NOT EXISTS idx_tract_risk_county ON layer6_risk_vulnerability_tract(fips_code);
CREATE INDEX IF NOT EXISTS idx_tract_risk_year ON layer6_risk_vulnerability_tract(data_year);
CREATE INDEX IF NOT EXISTS idx_tract_risk_composite ON layer6_risk_vulnerability_tract(risk_vulnerability_composite);
CREATE INDEX IF NOT EXISTS idx_tract_risk_slr ON layer6_risk_vulnerability_tract(slr_risk_score);
CREATE INDEX IF NOT EXISTS idx_tract_risk_heat ON layer6_risk_vulnerability_tract(heat_vulnerability_score);

-- =============================================================================
-- ADD NEW COLUMNS TO EXISTING COUNTY TABLE
-- =============================================================================
ALTER TABLE layer6_risk_drag
    -- Population context
    ADD COLUMN IF NOT EXISTS total_population INTEGER,
    ADD COLUMN IF NOT EXISTS vulnerable_population INTEGER,
    ADD COLUMN IF NOT EXISTS low_income_population INTEGER,

    -- v2 Climate Projections - Sea Level Rise
    ADD COLUMN IF NOT EXISTS slr_exposure_1ft NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS slr_exposure_2ft NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS slr_exposure_3ft NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS coastal_county BOOLEAN DEFAULT FALSE,
    ADD COLUMN IF NOT EXISTS slr_risk_score NUMERIC(5,4),

    -- v2 Climate Projections - Extreme Heat
    ADD COLUMN IF NOT EXISTS heat_days_above_95f_current INTEGER,
    ADD COLUMN IF NOT EXISTS heat_days_above_95f_2050 INTEGER,
    ADD COLUMN IF NOT EXISTS heat_days_above_100f_2050 INTEGER,
    ADD COLUMN IF NOT EXISTS heat_wave_duration_2050 INTEGER,
    ADD COLUMN IF NOT EXISTS urban_heat_island_intensity NUMERIC(6,2),
    ADD COLUMN IF NOT EXISTS impervious_surface_pct NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS tree_canopy_pct NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS heat_vulnerability_score NUMERIC(5,4),

    -- v2 Pollution (expanded)
    ADD COLUMN IF NOT EXISTS diesel_pm_exposure NUMERIC(8,2),
    ADD COLUMN IF NOT EXISTS air_toxics_cancer_risk NUMERIC(10,6),
    ADD COLUMN IF NOT EXISTS lead_paint_indicator NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS proximity_superfund NUMERIC(8,2),
    ADD COLUMN IF NOT EXISTS proximity_rmp_facilities NUMERIC(8,2),
    ADD COLUMN IF NOT EXISTS proximity_wastewater NUMERIC(8,2),
    ADD COLUMN IF NOT EXISTS pollution_burden_score NUMERIC(5,4),

    -- v2 Social Vulnerability (CDC SVI themes)
    ADD COLUMN IF NOT EXISTS socioeconomic_vulnerability NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS household_vulnerability NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS minority_language_vulnerability NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS housing_transport_vulnerability NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS social_vulnerability_index NUMERIC(5,4),

    -- v2 Infrastructure Resilience
    ADD COLUMN IF NOT EXISTS road_flood_exposure_pct NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS critical_facility_flood_risk INTEGER,
    ADD COLUMN IF NOT EXISTS power_outage_risk_score NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS broadband_access_pct NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS infrastructure_resilience_score NUMERIC(5,4),

    -- v2 Adaptive Capacity
    ADD COLUMN IF NOT EXISTS hospital_access_score NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS emergency_service_access_score NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS cooling_center_count INTEGER,
    ADD COLUMN IF NOT EXISTS green_space_pct NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS community_resilience_score NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS adaptive_capacity_index NUMERIC(5,4),

    -- Composite scores
    ADD COLUMN IF NOT EXISTS static_risk_score NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS climate_projection_score NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS vulnerability_score NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS resilience_deficit_score NUMERIC(5,4),
    ADD COLUMN IF NOT EXISTS modern_vulnerability_score NUMERIC(5,4),

    -- Data provenance
    ADD COLUMN IF NOT EXISTS ejscreen_year INTEGER,
    ADD COLUMN IF NOT EXISTS svi_year INTEGER,
    ADD COLUMN IF NOT EXISTS climate_projection_source VARCHAR(50),
    ADD COLUMN IF NOT EXISTS risk_version VARCHAR(20) DEFAULT 'v1-static';

-- Update existing records to mark as v1
UPDATE layer6_risk_drag
SET risk_version = 'v1-static'
WHERE risk_version IS NULL;

-- =============================================================================
-- CLIMATE PROJECTION REFERENCE TABLE
-- =============================================================================
CREATE TABLE IF NOT EXISTS climate_projection_reference (
    id SERIAL PRIMARY KEY,
    fips_code VARCHAR(5) NOT NULL,
    projection_type VARCHAR(50) NOT NULL,       -- 'sea_level_rise', 'extreme_heat', etc.
    scenario VARCHAR(20) NOT NULL,              -- 'RCP45', 'RCP85', 'intermediate', 'high'
    target_year INTEGER NOT NULL,               -- 2030, 2050, 2100

    -- Projection values
    value_low NUMERIC(10,4),
    value_median NUMERIC(10,4),
    value_high NUMERIC(10,4),
    unit VARCHAR(20),                           -- 'feet', 'days', 'degrees_f'

    -- Source tracking
    data_source VARCHAR(100),
    source_url VARCHAR(500),
    publication_year INTEGER,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uq_climate_projection UNIQUE (fips_code, projection_type, scenario, target_year)
);

CREATE INDEX IF NOT EXISTS idx_climate_proj_county ON climate_projection_reference(fips_code);
CREATE INDEX IF NOT EXISTS idx_climate_proj_type ON climate_projection_reference(projection_type);

-- =============================================================================
-- COMMENTS FOR DOCUMENTATION
-- =============================================================================
COMMENT ON TABLE layer6_risk_vulnerability_tract IS
'Tract-level risk vulnerability metrics combining static hazard exposure (v1), climate projections (v2), social vulnerability, and adaptive capacity.';

COMMENT ON COLUMN layer6_risk_vulnerability_tract.slr_exposure_2ft IS
'Fraction of tract land area exposed to inundation at 2ft sea level rise (2050 median projection). From NOAA SLR Viewer.';

COMMENT ON COLUMN layer6_risk_vulnerability_tract.heat_days_above_95f_2050 IS
'Projected number of days per year with max temperature above 95F by 2050 under RCP 4.5 scenario. From CDC/NOAA.';

COMMENT ON COLUMN layer6_risk_vulnerability_tract.social_vulnerability_index IS
'CDC Social Vulnerability Index (0-1). Higher values indicate greater vulnerability to hazard impacts.';

COMMENT ON COLUMN layer6_risk_vulnerability_tract.adaptive_capacity_index IS
'Composite measure of community ability to respond to and recover from hazards. Higher = more resilient.';

COMMENT ON COLUMN layer6_risk_vulnerability_tract.risk_vulnerability_composite IS
'Weighted composite: 0.4 x static_risk + 0.35 x climate_projection + 0.25 x (vulnerability - adaptive_capacity)';

COMMENT ON COLUMN layer6_risk_drag.modern_vulnerability_score IS
'v2 vulnerability score: 0.4 x climate_projection + 0.35 x social_vulnerability + 0.25 x (1-adaptive_capacity)';

COMMENT ON COLUMN layer6_risk_drag.risk_version IS
'v1-static: Original flood/pollution/bridge metrics. v2-vulnerability: Modern climate + social vulnerability analysis.';

COMMENT ON TABLE climate_projection_reference IS
'Reference table storing climate projection data by county for multiple scenarios and time horizons.';
