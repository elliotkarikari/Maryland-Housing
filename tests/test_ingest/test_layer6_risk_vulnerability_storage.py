import numpy as np
import pandas as pd

from src.ingest.layer6_risk_vulnerability import _build_risk_vulnerability_rows


def test_build_risk_vulnerability_rows_applies_defaults_and_expected_columns():
    df = pd.DataFrame(
        {
            "fips_code": ["24001"],
            "risk_drag_index": [np.nan],
            "data_year": [2024],
        }
    )

    rows = _build_risk_vulnerability_rows(df=df, data_year=2025, current_year=2026)
    row = rows[0]

    assert row["fips_code"] == "24001"
    assert row["data_year"] == 2024  # preserve row-provided value
    assert row["risk_version"] == "v2-vulnerability"
    assert row["ejscreen_year"] == 2025
    assert row["svi_year"] == 2025
    assert row["climate_projection_source"] == "NOAA_SLR_CDC_HEAT"
    assert row["risk_drag_index"] is None
    assert "pm25_avg" in row
    assert "vulnerability_score" in row
